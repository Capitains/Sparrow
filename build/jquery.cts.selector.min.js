!function(a){"function"==typeof define&&define.amd?define(["jquery","cts"],a):a(jQuery,CTS)}(function(a,b){function c(c,h){this.element=a(c),this.settings=a.extend({},e,h),this._name=d,this.lang=this.settings.lang in g?g[this.settings.lang]:g.en,this.repository=new b.repository.repository(this.settings.endpoint,3),this._defaultCSS=f,this.css=this.mergeCSS(),this.init(),this.settings.retrieve!==!1&&this.retriever_init(this.settings.retrieve)}var d="jQuery.cts.selector",e={endpoint:"http://www.perseus.tufts.edu/hopper/CTS?",inventories:{},version:3,namespace:"http://chs.harvard.edu/xmlns/cts3/ti",lang:"en",css:{},retrieve:!1,retrieve_scope:null,passage:!0},f={container:["cts-selector"],"retrieve-button":[],"hidden-inventory":["cts-hidden-inventory"],"select-inventory":["cts-selector-inventory"],"select-textgroup":["cts-selector-textgroup"],"select-work":["cts-selector-work"],"select-text":["cts-selector-text"],"trigger-button":["cts-selector-trigger"],"citation-fieldset":["cts-selector-citation"],"citation-fieldset-legend":[],"citation-label":[],"citation-input":["cts-selector-passage"],"citation-input-container":["cts-selector-input-container"]},g={};a.extend(c.prototype,{generateId:function(){for(var b=1;a("div#cts-service-"+b).length>=1;)b+=1;return b="cts-service-"+b,this.id=b,b},retriever_init:function(c){{var d,e=this,f=a("<button />",{"class":e.getClass("retrieve-button")});e.element.val()}d="string"==typeof c?a(c):e.element,f.text(b.lang.get("retrieve_passage",e.lang)),e.element.after(f),f.on("click",function(a){a.stopPropagation(),a.preventDefault(),f.text(b.lang.get("loading",e.lang)),d.trigger("cts-passage:retrieving"),e.text=new b.text.Passage(e.element.val(),e.repository.endpoint,e.element.data("inventory")),e.text.retrieve(function(){e.text.checkXML()===!0?(d.val(e.text.getXml(e.settings.retrieve_scope,"string")),d.trigger("cts-passage:retrieved")):(console.log(0,"XML is empty"),d.trigger("cts-passage:passage-error")),f.text(b.lang.get("retrieve_passage",e.lang))},function(a,c){console.log(a,c),d.trigger("cts-passage:retrieving-error"),f.text(b.lang.get("retrieve_passage",e.lang))})})},getClass:function(a){return this.css[a].length>0?this.css[a].join(" "):""},mergeCSS:function(){var a=this,b={};return Object.keys(a._defaultCSS).forEach(function(c){b[c]=c in a.settings.css&&a.settings.css[c]instanceof Array?a._defaultCSS[c].concat(a.settings.css[c]):a._defaultCSS[c]}),b},init:function(){var a=this;Object.keys(a.settings.inventories).map(function(b){a.repository.addInventory(b,a.settings.inventories[b])}),a.repository.load(function(){a.generate()})},writePassage:function(b){for(var c,d=this,e=d.element,f=e.data("urn"),g=[],h=[],i=b.data("level"),j=b.attr("id"),k=0,l=0;i>k;){c=b.find("input#"+j+"-0-level-"+k);var l=c.val();if(!l||/^\s*$/.test(l))break;g.push(l),k+=1}if(g.length>0){for(f+=":"+g.join("."),k=0;i>k;){c=b.find("input#"+j+"-1-level-"+k);var l=c.val();if(!l||/^\s*$/.test(l))break;h.push(l),k+=1}h.length==g.length&&(f+="-"+h.join("."))}e.val(f),e.data("inventory",a("div#"+j+" .cts-selector-inventory, div#"+j+" .cts-hidden-inventory").val()),d.element.trigger("cts-passage:urn-updated"),d.element.trigger("cts-passage:urn-passage")},passage:function(c,d){var e,f,g,h=a(c),i=h.find("option:selected"),j=d.find("fieldset.cts-selector-citation"),k=0,l=i.data("citations"),m=0,n=d.attr("id"),o=this;for(o.element.val(c.value),d.data("level",l.length),j.length>0&&j.remove();2>m;)k=0,f=a("<fieldset />",{"class":o.getClass("citation-fieldset")}),$legend=a("<legend />",{"class":o.getClass("citation-fieldset-legend")}),$text="stop_passage",m%2===0&&($text="start_passage"),$legend.text(b.lang.get($text,o.lang)),f.append($legend),l.forEach(function(b){g=n+"-"+m+"-level-"+k,$label=a("<label />",{"for":g,"class":o.getClass("citation-label")}),$input_container=a("<div />",{"class":o.getClass("citation-input-container")}),$label.text(b+" : "),$input_container.append($label),e=a("<input />",{name:"passage_"+k,type:"number",size:4,min:0,"class":o.getClass("citation-input"),id:g,value:1}),$label.after(e),e.on("change",function(){o.writePassage(d)}),f.append($input_container),k+=1}),d.append(f),m+=1;e.trigger("change")},select:function(a,b){var c,d,e;a.hasClass("cts-selector-inventory")?(d=[".cts-selector-textgroup",".cts-selector-work",".cts-selector-text",".cts-selector-citation"],c=".cts-selector-textgroup[data-inventory='"+a.val()+"']"):a.hasClass("cts-selector-textgroup")?(d=[".cts-selector-work",".cts-selector-text",".cts-selector-citation"],c=".cts-selector-work[data-inventory='"+a.attr("data-inventory")+"'][data-textgroup='"+a.val()+"']"):a.hasClass("cts-selector-work")&&(d=[".cts-selector-text",".cts-selector-citation"],c=".cts-selector-text[data-inventory='"+a.attr("data-inventory")+"'][data-work='"+a.val()+"']"),b.find(d.join(", ")).hide(),e=b.find(c),e.show(),1===e.find("option").length&&e.trigger("change")},generate:function(){for(var c=1,d=!1,e=!1,f=!1,g=!1;1==a("div#cts-selector-"+c).length;)c+=1;var c="cts-selector-"+c;this.id=c;var h=this.repository.inventories,i=this,j=a("<div />",{id:c,"class":i.getClass("container")});if(this.element.after(j),Object.keys(h).length>1){var k=a("<select />",{name:"inventory_name","class":i.getClass("select-inventory")});Object.keys(i.settings.inventories).forEach(function(b){var c=a("<option />",{value:b}).text(i.settings.inventories[b]);k.append(c)}),d||(d=k),j.append(k),k.on("change",function(){i.select(a(this),j)})}else{var k=a("<input />",{type:"hidden",name:"inventory_name","class":i.getClass("hidden-inventory"),value:Object.keys(this.settings.inventories)[0]});d=k,j.append(k)}Object.keys(i.settings.inventories).forEach(function(c){var d=a("<select />",{name:"cts-selector-"+c+"-textgroup","data-inventory":c,style:"display:none;","class":i.getClass("select-textgroup")});d.on("change",function(){i.select(a(this),j)}),j.append(d),e||(e=d),i.repository.inventories[c].textgroups.forEach(function(e){var h=a("<option />",{value:e.urn});h.text(e.getTitle(i.lang));var k=a("<select />",{name:"cts-selector-"+c+"-work","data-inventory":c,"data-textgroup":e.urn,style:"display:none;","class":i.getClass("select-work")});f||(f=k),j.append(k),k.on("change",function(){i.select(a(this),j)}),e.works.forEach(function(d){var f=a("<option />",{value:d.urn});f.text(d.getTitle(i.lang)),k.append(f);var h=a("<select />",{name:"cts-selector-"+c+"-work-texts","data-inventory":c,"data-textgroup":e.urn,"data-work":d.urn,style:"display:none;","class":i.getClass("select-text")});g||(g=h),d.texts.forEach(function(c){var d=a("<option />",{value:c.urn});d.data("citations",c.citations),d.text(b.lang.get(c.type,i.lang)+" "+c.getTitle(i.lang)),h.append(d)}),j.append(h),h.on("change",function(){i.settings.passage!==!0?i.element.val(this.value):(i.element.data("urn",this.value),i.passage(this,j)),i.element.trigger("cts-passage:urn-updated"),i.element.trigger("cts-passage:urn-work")})}),d.append(h)})}),j.find("div[data-inventory='"+d.val()+"']").show(),e.show(),f.show(),g.show();var l=a("<button />",{"class":i.getClass("trigger-button")});l.text(b.lang.get("select",i.lang)),l.on("click",function(a){a.stopPropagation(),a.preventDefault(),j.find("select:visible").last().trigger("change")}),j.append(l)}}),a.fn.ctsSelector=function(b){var d=arguments;if(!window.CTS)throw new Error("CTS lib required");if(void 0===b||"object"==typeof b)return this.each(function(){a.data(this,"_cts_selector")||a.data(this,"_cts_selector",new c(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var e;return this.each(function(){var f=a.data(this,"_cts_selector");f instanceof c&&"function"==typeof f[b]&&(e=f[b].apply(f,Array.prototype.slice.call(d,1))),"destroy"===b&&a.data(this,"_cts_selector",null)}),void 0!==e?e:this}}});