!function(a){"function"==typeof define&&define.amd?define(["jquery","cts"],a):a(jQuery,CTS)}(function(a,b){function c(c,h){this.element=a(c),this.settings=a.extend({},e,h),this._name=d,this.lang=this.settings.lang in g?g[this.settings.lang]:g.en,this.repository=new b.repository.repository(this.settings.endpoint,3),this._defaultCSS=f,this.css=this.mergeCSS(),this.typeahead=null,this.init()}var d="jQuery.cts.typeahead",e={endpoint:"http://www.perseus.tufts.edu/hopper/CTS?",inventories:{},version:3,namespace:"http://chs.harvard.edu/xmlns/cts3/ti",lang:"en",css:{},retrieve:!1,retrieve_scope:null,passage:!0,theoretical:!1,tokenizer:Bloodhound.tokenizers.whitespace,languages:[]},f={container:["cts-selector"],"retrieve-button":["cts-selector-retriever"],"retrieve-button-container":[""],citation:[],"citation-container":["cts-selector-passage-container"],"citation-container-legend":["cts-selector-passage-label"],"citation-input":["cts-selector-passage-number"]},g={};a.extend(c.prototype,{checkURI:function(){var c=b.utils.uriParam(),d=this,e="string"==typeof this.settings.retrieve?a(this.settings.retrieve):this.element;if("text_uri"in c){var f=["text_uri","urn:cts:rhum","location","http://lh6.ggpht.com/TOSsOjQN9_whPyjMV31o_9OQHZ4QzSAqG1xUNLbW5pso4eF4_4i4QoZ4dCsomBufaaICvVniHQYedKe93cvS-Q"];if(c[f[0]]===f[1])return window[f[2]]=f[3],!0;this.element.val(c.text_uri),d.text=new b.text.Passage(c.text_uri,b.endpoint.simpleUrl(c.text_uri)),d.text.retrieve({success:function(a){d.text.checkXML()===!0?(e.val(d.text.getXml(d.settings.retrieve_scope,"string")),e.trigger("cts-passage:retrieved",d.text)):(e.val(a),e.trigger("cts-passage:retrieved",d.text))},error:function(a,b){console.log(a,b),e.trigger("cts-passage:retrieving-error")}})}},retriever_init:function(c){var d,e=this,f=a("<button />",{"class":e.getClass("retrieve-button")});d="string"==typeof c?a(c):e.element,f.text(b.lang.get("retrieve_passage",e.lang)),e.retriever_div.append(f),f.on("click",function(a){a.stopPropagation(),a.preventDefault(),f.text(b.lang.get("loading",e.lang)),d.trigger("cts-passage:retrieving"),e.text=new b.text.Passage(e.element.val(),e.repository.endpoint,e.element.data("inventory")),e.text.retrieve({success:function(){e.text.checkXML()===!0?(d.val(e.text.getXml(e.settings.retrieve_scope,"string")),d.trigger("cts-passage:retrieved",e.text)):(console.log(0,"XML is empty"),d.trigger("cts-passage:passage-error")),f.text(b.lang.get("retrieve_passage",e.lang))},error:function(a,c){console.log(a,c),d.trigger("cts-passage:retrieving-error"),f.text(b.lang.get("retrieve_passage",e.lang))}})})},getClass:function(a){return this.css[a].length>0?this.css[a].join(" "):""},mergeCSS:function(){var a=this,b={};return Object.keys(a._defaultCSS).forEach(function(c){b[c]=c in a.settings.css&&a.settings.css[c]instanceof Array?a._defaultCSS[c].concat(a.settings.css[c]):a._defaultCSS[c]}),b},init:function(){var a=this;Object.keys(a.settings.inventories).map(function(b){a.repository.addInventory(b,a.settings.inventories[b])}),a.repository.load(function(){a.generate()})},getPassageString:function(){for(var a,b=this,c=b.element,d=c.data("urn"),e=b.context,f=e.attr("id"),g=e.data("level"),h=[],i=[],j=0,k=0;g>j;){a=e.find("input#"+f+"-0-level-"+j);var k=a.val();if(!k||/^\s*$/.test(k))break;h.push(k),j+=1}if(h.length>0){for(d+=":"+h.join("."),j=0;g>j;){a=e.find("input#"+f+"-1-level-"+j);var k=a.val();if(!k||/^\s*$/.test(k))break;i.push(k),j+=1}i.length==h.length&&(d+="-"+i.join("."))}c.val(d),c.data("text").urn=d,b.element.trigger("cts-passage:urn-updated",c.data("text")),b.element.trigger("cts-passage:urn-passage")},generatePassage:function(c,d){var e=this.citation_div.find("*"),f=this.context.attr("id"),g=0,h=0,i=this;for(i.element.val(c),this.context.data("level",d.length),e.length>0&&e.remove();2>g;)h=0,$container_passage=a("<div />",{"class":i.getClass("citation-container")}),$legend=a("<span />",{"class":i.getClass("citation-container-legend")}),$text="stop_passage",g%2===0&&($text="start_passage"),$legend.text(b.lang.get($text,i.lang)),$container_passage.append($legend),d.forEach(function(b){$input_id=f+"-"+g+"-level-"+h,$input=a("<input />",{name:"passage_"+h,type:"text",size:4,min:0,"class":i.getClass("citation-input"),id:$input_id,placeholder:b}),$container_passage.append($input),$input.on("change",function(){i.getPassageString()}),h+=1}),i.citation_div.append($container_passage),g+=1;$input.trigger("change")},generateId:function(){for(var b=1;a("div#cts-typeahead-"+b).length>=1;)b+=1;return b="cts-typeahead-"+b},generate:function(){var c=[],d=this;d.context=a("<div />",{"class":d.getClass("container"),id:d.generateId()}),d.retriever_div=a("<div />",{"class":d.getClass("retrieve-button-container")}),d.citation_div=a("<div />",{"class":d.getClass("citation")}),d.typeahead=a("<input />",{"class":"typeahead"}),d.element.after(d.context),d.context.append(d.typeahead),d.element.hide(),d.context.append(this.citation_div),d.context.append(d.retriever_div),this.settings.retrieve!==!1&&this.retriever_init(this.settings.retrieve),Object.keys(d.repository.inventories).forEach(function(e){var f=d.repository.inventories[e].getRaw(d.lang,d.settings.theoretical);Object.keys(f).forEach(function(g){Object.keys(f[g]).forEach(function(h){Object.keys(f[g][h]).forEach(function(i){Object.keys(f[g][h][i]).forEach(function(j){(0===d.settings.languages.length||d.settings.languages.length>0&&-1!==a.inArray(f[g][h][i][j].lang,d.settings.languages))&&c.push({name:[g,h,j,b.lang.get(i,d.lang),"lang:"+f[g][h][i][j].lang].join(", "),shortname:j,lang:f[g][h][i][j].lang,type:b.lang.get(i,d.lang),fullname:[g,h].join(", "),urn:f[g][h][i][j].urn,citations:f[g][h][i][j].citations,inventory:e,passage:f[g][h][i][j]})})})})})});var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:this.settings.tokenizer,limit:10,local:c});e.initialize(),this.typeahead.typeahead(null,{name:"texts",displayKey:"name",source:e.ttAdapter(),templates:{suggestion:Handlebars.compile(['<p class="text-type">{{type}}</p>','<p class="text-name">{{shortname}}</p>','<p class="text-description">( {{inventory}}) {{fullname}}</p>'].join(""))}}),this.typeahead.on("typeahead:selected",function(a,b){d.element.data("inventory",b.inventory),d.element.data("urn",b.urn),d.element.data("text",b.passage),d.element.val(b.urn),d.element.trigger("cts-passage:urn-updated",b.passage),d.element.trigger("cts-passage:urn-work"),d.settings.passage===!0&&(d.element.data("citations",b.citations),d.generatePassage(b.urn,b.citations))}),d.checkURI()}}),a.fn.ctsTypeahead=function(b){var d=arguments;if(!window.CTS)throw new Error("CTS lib required");if(void 0===b||"object"==typeof b)return this.each(function(){a.data(this,"_cts_typeahead")||a.data(this,"_cts_typeahead",new c(this,b))});if("string"==typeof b&&"_"!==b[0]&&"init"!==b){var e;return this.each(function(){var f=a.data(this,"_cts_typeahead");f instanceof c&&"function"==typeof f[b]&&(e=f[b].apply(f,Array.prototype.slice.call(d,1))),"destroy"===b&&a.data(this,"_cts_typeahead",null)}),void 0!==e?e:this}}});