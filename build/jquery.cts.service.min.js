!function(a){"function"==typeof define&&define.amd?define(["jquery","cts"],a):a(jQuery,CTS)}(function(a,b){function c(c,h,i){this.element=a(c),this.settings=a.extend({},e,i),this._name=d,this.serviceName=h,this.service=b.service["new"](h,this.settings.endpoint,{}),this.lang=this.settings.lang in g?g[this.settings.lang]:g.en,this._defaultCSS=f,this.css=this.mergeCSS(),this.inputs={},this.init()}var d="jQuery.cts.service",e={endpoint:"http://www.perseus.tufts.edu/hopper/CTS?",lang:"en",css:{},trigger:null,click:null,driver:{},defaults:{},show:!0,callback:null,names:{}},f={container:["cts-service"],"container-legend":["cts-service-legend"],"field-container":[],"field-label":[],"field-input-container":[],"field-text":[],"field-textarea":[],"field-checkbox":[]},g={en:"en"};a.extend(c.prototype,{generateId:function(){for(var b=1;a("div#cts-service-"+b).length>=1;)b+=1;return b="cts-service-"+b,this.id=b,b},send:function(){var a=this.getValues(),b=this;Object.keys(a).forEach(function(c){b.service.setValue(c,a[c])}),b.element.trigger("cts-service:"+b.serviceName+":doing"),b.service.send(function(a){"function"==typeof b.settings.callback&&b.settings.callback.call(b.element,a),b.element.trigger("cts-service:"+b.serviceName+":done")},"text")},makeInput:function(b,c){var d,e=this,f=b in this.settings.defaults?this.settings.defaults[b]:this.service.options[b]["default"];if("hidden"===c.html)d=a("<input />",{type:"hidden",value:f}),e.container.append(d);else{var g=a("<div />",{"class":e.getClass("field-container")}),h=a("<label />",{"class":e.getClass("field-label"),"for":e.id+"-"+b}),i=a("<div />",{"class":e.getClass("field-input-container")});h.text(e.translate(b)),g.append(h),"checkbox"===c.html?(d=a("<input />",{type:"checkbox","class":e.getClass("field-checkbox")}),d[0].checked=f):"input"===c.html?d=a("<input />",{type:"text",value:f,"class":e.getClass("field-text")}):"textarea"===c.html&&(d=a("<textarea />",{type:"text",value:f,"class":e.getClass("field-textarea")}),d.text(f)),d.attr("id",e.id+"-"+b),i.append(d),g.append(i),e.container.append(g)}return b in e.settings.names&&d.attr("name",e.settings.names[b]),d},init:function(){var c=this;c.generateId(),c.container=a("<fieldset />",{"class":c.getClass("container"),id:c.id}),c.legend=a("<legend />",{"class":c.getClass("container-legend")}),c.legend.text(b.lang.get(c.serviceName,c.lang)),c.container.append(c.legend),this.element.append(c.container),Object.keys(c.service.options).forEach(function(a){var b;b=a in c.settings.driver?c.settings.driver[a]:c.makeInput(a,c.service.options[a]),c.inputs[a]=b}),"string"==typeof c.settings.trigger&&c.element.on(c.settings.trigger,function(){c.send()}),"undefined"!=typeof c.settings.click&&null!==c.settings.click&&("string"==typeof c.settings.click?a(c.settings.click).on("click",function(){c.send()}):c.settings.click instanceof jQuery&&c.settings.click.on("click",function(){c.send()})),c.settings.show===!1?c.container.hide():"string"==typeof c.settings.show&&c.element.on(c.settings.show,function(){c.container.toggle()})},getValues:function(){var b=this,c={};return Object.keys(b.inputs).forEach(function(d){var e=b.inputs[d];if("string"==typeof e){var e=a(e);c[d]="checkbox"===e.attr("type")?a(e).is(":checked"):a(e).val()}else c[d]="function"==typeof e?e():e.is("[type='checkbox']")?e.is(":checked"):e.val();"string"==typeof c[d]&&("boolean"===b.service.options[d].type?c[d]="true"===c[d]||c[d]===!0?!0:!1:"list"===b.service.options[d].type&&(c[d]=c[d].replace(/\s+/g,"").split(",")))}),c},translate:function(a){return b.lang.get(this.serviceName+"."+a,this.lang)},getClass:function(a){return this.css[a].length>0?this.css[a].join(" "):""},mergeCSS:function(){var a=this,b={};return Object.keys(a._defaultCSS).forEach(function(c){b[c]=c in a.settings.css&&a.settings.css[c]instanceof Array?a._defaultCSS[c].concat(a.settings.css[c]):a._defaultCSS[c]}),b},instance:function(){return this.service}}),a.fn.ctsService=function(b,d){var e=arguments;if(!window.CTS)throw new Error("CTS lib required");if(void 0===d||"object"==typeof d)return this.each(function(){a.data(this,"_cts_service_"+b)||a.data(this,"_cts_service_"+b,new c(this,b,d))});if("string"==typeof d&&"_"!==d[0]&&"init"!==d){var f;return this.each(function(){var g=a.data(this,"_cts_service_"+b);g instanceof c&&"function"==typeof g[d]&&(f=g[d].apply(g,Array.prototype.slice.call(e,1))),"destroy"===d&&a.data(this,"_cts_service_"+b,null)}),void 0!==f?f:this}}});